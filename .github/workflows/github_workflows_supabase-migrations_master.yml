
on:
  push:
    branches: [ "master" ]
    paths:
      - 'supabase/migrations/**'
  workflow_dispatch:
    inputs:
      run_migrations:
        description: 'Executar migrações no Supabase?'
        required: false
        default: 'true'

jobs:
  migrate:
    name: Aplicar migrations no Supabase (CLI)
    runs-on: ubuntu-latest
    if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/master') || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_migrations == 'true') }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Supabase CLI
        run: npm install -g supabase

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_ACCESS_TOKEN }}" ]; then
            echo "ERRO: secret SUPABASE_ACCESS_TOKEN não definido."
            exit 1
          fi
          if [ -z "${{ secrets.SUPABASE_PROJECT_REF_MASTER }}" ]; then
            echo "ERRO: secret SUPABASE_PROJECT_REF não definido."
            exit 1
          fi

      - name: Apply Supabase migrations (supabase db push)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF_MASTER }}
        run: |
          set -euo pipefail

          if [ ! -d "./supabase/migrations" ]; then
            echo "ERRO: diretório supabase/migrations não encontrado. Nada a aplicar."
            exit 1
          fi

          echo "Autenticando Supabase CLI"
          supabase login --token "$SUPABASE_ACCESS_TOKEN"

          echo "Linkando repositório ao projeto $SUPABASE_PROJECT_REF (ignora erro se já linkado)"
          supabase link --project-ref "$SUPABASE_PROJECT_REF" || true

          echo "Aplicando migrations (supabase db push) para $SUPABASE_PROJECT_REF"
          supabase db push --project-ref "$SUPABASE_PROJECT_REF"