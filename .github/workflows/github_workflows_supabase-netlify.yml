# GitHub Actions: Supabase migrations (remote via Supabase CLI) + Netlify deploy
#
# Requisitos (Secrets):
# - SUPABASE_ACCESS_TOKEN  -> token (geralmente service_role ou token com permissões de projeto)
# - SUPABASE_PROJECT_REF   -> project ref (ex: abcd1234efgh)
# - NETLIFY_AUTH_TOKEN
# - NETLIFY_SITE_ID
#
# Estrutura esperada de migrations:
# - supabase/migrations/*.sql  (padrão da Supabase CLI)
#
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      run_migrations:
        description: 'Executar migrações no Supabase?'
        required: false
        default: 'true'
      deploy:
        description: 'Fazer deploy no Netlify?'
        required: false
        default: 'false'

jobs:
  migrate:
    name: Aplicar migrations no Supabase (CLI)
    runs-on: ubuntu-latest
    # Executa em push na main ou quando chamado manualmente com run_migrations = true
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_migrations == 'true') }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Supabase CLI
        run: npm install -g supabase

      - name: Apply Supabase migrations (supabase db push)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          set -euo pipefail

          # Verifica pasta de migrations padrão da Supabase
          if [ ! -d "./supabase/migrations" ]; then
            echo "ERRO: diretório supabase/migrations não encontrado. Coloque suas migrations em supabase/migrations."
            exit 1
          fi

          echo "Usando Supabase CLI para aplicar migrations para o projeto $SUPABASE_PROJECT_REF"
          # Autentica a CLI (usa a variável de ambiente)
          supabase login --token "$SUPABASE_ACCESS_TOKEN"

          # Linka o diretório ao projeto (não falha se já linkado)
          supabase link --project-ref "$SUPABASE_PROJECT_REF" || true

          # Aplica as migrations (verifique localmente antes de rodar em produção)
          supabase db push --project-ref "$SUPABASE_PROJECT_REF"

  deploy:
    name: Deploy to Netlify
    runs-on: ubuntu-latest
    needs: migrate
    if: ${{ github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true')) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Netlify CLI
        run: npm install -g netlify-cli

      - name: Deploy to Netlify (prod)
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          DEPLOY_DIR="./" # ajuste se seu index.html estiver em ./public
          echo "Deploying $DEPLOY_DIR to Netlify site $NETLIFY_SITE_ID"
          npx netlify-cli deploy --prod --dir="$DEPLOY_DIR" --site="$NETLIFY_SITE_ID"